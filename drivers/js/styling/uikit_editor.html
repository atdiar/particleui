<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI Kit Editor</title>
    <style>
        /* Existing styles remain here */

        /* CSS Reset Rules */
        .css-reset {

            /* 1. Use a more-intuitive box-sizing model. */
            *,
            *::before,
            *::after {
                box-sizing: border-box;
            }

            /* 2. Remove default margin */
            * {
                margin: 0;
            }

            /* 3. Add accessible line-height, 4. Improve text rendering */
            body {
                line-height: 1.5;
                -webkit-font-smoothing: antialiased;
            }

            /* 5. Improve media defaults */
            img,
            picture,
            video,
            canvas,
            svg {
                display: block;
                max-width: 100%;
            }

            /* 6. Remove built-in form typography styles */
            input,
            button,
            textarea,
            select {
                font: inherit;
            }

            /* 7. Avoid text overflows */
            p,
            h1,
            h2,
            h3,
            h4,
            h5,
            h6 {
                overflow-wrap: break-word;
            }

            /* 8. Create a root stacking context */
            #root,
            #__next {
                isolation: isolate;
            }
        }
    </style>
    <style>
        body {
            font-family: Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .editor-container {
            display: flex;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .element-container {
            flex: 1;
            padding: 10px;
        }

        .css-editor {
            flex: 1;
            margin-left: 20px;
        }

        textarea {
            width: 100%;
            height: 150px;
            resize: vertical;
        }

        .background-editor {
            margin-top: 20px;
        }

        #element-selector {
            margin-bottom: 20px;
            padding: 5px;
        }

        #add-element {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        .remove-element {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            margin-top: 10px;
        }

        .pseudo-selector {
            margin-top: 10px;
        }

        .css-display-area {
            position: relative;
            margin-top: 20px;
        }

        .css-display-area i {
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 0.8em;
            color: #666;
            
        }

        .css-display {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            white-space: pre;
            font-family: monospace;
        }

        .css-display:focus {
            outline: 2px solid #007bff;
        }

        .css-textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
        }

        .editable-element-container {
            position: relative;
            margin-top: 20px;
        }

        .editable-element-container i {
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 0.8em;
            color: #666; /* wtf Claude AI?!!! *dead* */
        }

        .editable-element-container .editable-element {
            width: 100%;
            max-width: 300px; /* Default max-width */
            overflow: auto; /* Enable both horizontal and vertical scrolling when needed */
            transition: max-width 0.3s ease; /* Smooth transition for width change */
        }

        .editable-element-container:has(*:hover) .editable-element {
            max-width: 100%; /* Expand to full width on hover of any child element */
        }

        #element-selector option:disabled {
            color: #999;
            font-style: italic;
        }

        .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        width: 80%;
        max-width: 800px;
        position: relative;
    }

    .close {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .go-code-pre {
        background-color: #f4f4f4;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        white-space: pre;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
    }

    .view-go-code-btn {
        align-self: start;
        margin-top:10px;
        word-wrap:normal;
        white-space: nowrap;
        word-break: keep-all;
    }
        
    </style>
</head>

<body>
    <div id="goCodeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Go Styling function for Zui</h2>
            <pre id="modalGoCode" class="go-code-pre"></pre>
        </div>
    </div>
    <div id="save-indicator"></div>
    <h1>UI Kit Editor</h1>
    <div class="global-styles">
        <h2>Global Styles</h2>
    
    <div class="reset-css">
        <label>
            <input type="checkbox" id="reset-css-toggle" checked>
            Reset CSS
        </label>
        <details>
            <summary>View Reset CSS</summary>
            <pre id="reset-css-display"></pre>
        </details>
    </div>

    <div class="generated-global-styles">
        <h3>Generated Global Styles</h3>
        <div>
            <label for="font-family">Font Family:</label>
            <select id="font-family">
                <option value="Arial, sans-serif">Arial</option>
                <option value="Verdana, sans-serif">Verdana</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="Georgia, serif">Georgia</option>
            </select>
        </div>
        <div>
            <label for="font-size">Font Size:</label>
            <input type="range" id="font-size" min="12" max="24" value="16">
            <span id="font-size-value">16px</span>
        </div>
        <div>
            <label for="text-color">Text Color:</label>
            <input type="color" id="text-color" value="#000000">
        </div>
        <div>
            <label for="line-height">Line Height:</label>
            <input type="range" id="line-height" min="1" max="2" step="0.1" value="1.5">
            <span id="line-height-value">1.5</span>
        </div>
        <div>
            <label for="page-padding">Page Padding:</label>
            <input type="number" id="page-padding" min="0" max="100" value="20">
            <span>px</span>
        </div>
        <div>
            <label for="page-width">Page Width:</label>
            <input type="number" id="page-width" min="200" max="2000" value="800">
            <span>px</span>
        </div>
        <div>
            <label for="color-picker">Background Color:</label>
            <input type="color" id="color-picker" value="#ffffff">
        </div>
        <details>
            <summary>View Generated CSS</summary>
            <pre id="generated-css-display"></pre>
        </details>
    </div>

    <div class="user-global-css">
        <h3>User Global CSS</h3>
        <textarea id="user-global-css" rows="10" cols="50" placeholder="Add your custom global CSS here"></textarea>
    </div>

        <button id="new-stylesheet" style="background-color: #2f69f0; color: white;">New Stylesheet</button>
        <!-- Other global style controls remain here -->
    </div>

    <select id="element-selector">
        <option value="">Select an element to add</option>
        <option value="a">a (Anchor)</option>
        <option value="abbr">abbr (Abbreviation)</option>
        <option value="address">address</option>
        <option value="article">article</option>
        <option value="aside">aside</option>
        <option value="audio">audio</option>
        <option value="blockquote">blockquote</option>
        <option value="button">button</option>
        <option value="canvas">canvas</option>
        <option value="caption">caption</option>
        <option value="cite">cite</option>
        <option value="code">code</option>
        <option value="data">data</option>
        <option value="dd">dd (Description Details)</option>
        <option value="del">del</option>
        <option value="details">details</option>
        <option value="dfn">dfn</option>
        <option value="dialog">dialog</option>
        <option value="div">div</option>
        <option value="dl">dl (Description List)</option>
        <option value="dt">dt (Description Term)</option>
        <option value="em">em (Emphasis)</option>
        <option value="fieldset">fieldset</option>
        <option value="figcaption">figcaption</option>
        <option value="figure">figure</option>
        <option value="footer">footer</option>
        <option value="form">form</option>
        <option value="h1">h1</option>
        <option value="h2">h2</option>
        <option value="h3">h3</option>
        <option value="h4">h4</option>
        <option value="h5">h5</option>
        <option value="h6">h6</option>
        <option value="header">header</option>
        <option value="hr">hr (Horizontal Rule)</option>
        <option value="i">i (Italic)</option>
        <option value="img">img (Image)</option>
        <option value="input">input (Generic)</option>
        <option value="input[type='text']">input (Text)</option>
        <option value="input[type='password']">input (Password)</option>
        <option value="input[type='email']">input (Email)</option>
        <option value="input[type='number']">input (Number)</option>
        <option value="input[type='tel']">input (Telephone)</option>
        <option value="input[type='url']">input (URL)</option>
        <option value="input[type='search']">input (Search)</option>
        <option value="input[type='date']">input (Date)</option>
        <option value="input[type='time']">input (Time)</option>
        <option value="input[type='datetime-local']">input (Datetime-local)</option>
        <option value="input[type='month']">input (Month)</option>
        <option value="input[type='week']">input (Week)</option>
        <option value="input[type='color']">input (Color)</option>
        <option value="input[type='file']">input (File)</option>
        <option value="input[type='range']">input (Range)</option>
        <option value="input[type='checkbox']">input (Checkbox)</option>
        <option value="input[type='radio']">input (Radio)</option>
        <option value="input[type='submit']">input (Submit)</option>
        <option value="input[type='reset']">input (Reset)</option>
        <option value="input[type='button']">input (Button)</option>
        <option value="ins">ins</option>
        <option value="kbd">kbd</option>
        <option value="label">label</option>
        <option value="legend">legend</option>
        <option value="li">li (List Item)</option>
        <option value="main">main</option>
        <option value="mark">mark</option>
        <option value="meter">meter</option>
        <option value="nav">nav</option>
        <option value="ol">ol (Ordered List)</option>
        <option value="option">option</option>
        <option value="output">output</option>
        <option value="p">p (Paragraph)</option>
        <option value="pre">pre</option>
        <option value="progress">progress</option>
        <option value="q">q (Quote)</option>
        <option value="s">s (Strikethrough)</option>
        <option value="samp">samp</option>
        <option value="section">section</option>
        <option value="select">select</option>
        <option value="small">small</option>
        <option value="span">span</option>
        <option value="strong">strong</option>
        <option value="sub">sub</option>
        <option value="summary">summary</option>
        <option value="sup">sup</option>
        <option value="table">table</option>
        <option value="tbody">tbody</option>
        <option value="td">td (Table Cell)</option>
        <option value="textarea">textarea</option>
        <option value="tfoot">tfoot</option>
        <option value="th">th (Table Header)</option>
        <option value="thead">thead</option>
        <option value="time">time</option>
        <option value="tr">tr (Table Row)</option>
        <option value="u">u (Underline)</option>
        <option value="ul">ul (Unordered List)</option>
        <option value="var">var</option>
        <option value="video">video</option>
    </select>
    <button id="add-element">Add Element</button>

    <div id="elements-container"></div>

    <script>
        const cssToGoMapping = {
            'box-shadow': 'Container.Layout.BoxShadow',
            'justify-content': 'Container.Layout.JustifyContent',
            'z-index': 'Container.Layout.ZIndex',
            'float': 'Container.Layout.Float',
            'overflow': 'Container.Layout.Overflow',
            'overflow-y': 'Container.Layout.OverflowY',
            'perspective': 'Container.Layout.Perspective',
            'border-collapse': 'Container.Layout.BorderCollapse',
            'page-break-before': 'Container.Layout.PageBreakBefore',
            'columns': 'Container.Layout.Columns',
            'column-count': 'Container.Layout.ColumnCount',
            'min-height': 'Container.Layout.MinHeight',
            'page-break-inside': 'Container.Layout.PageBreakInside',
            'column-gap': 'Container.Layout.ColumnGap',
            'clip': 'Container.Layout.Clip',
            'flex-direction': 'Container.Layout.FlexDirection',
            'page-break-after': 'Container.Layout.PageBreakAfter',
            'top': 'Container.Layout.Top',
            'counter-increment': 'Container.Layout.CounterIncrement',
            'height': 'Container.Layout.Height',
            'transform-style': 'Container.Layout.TransformStyle',
            'overflow-x': 'Container.Layout.OverflowX',
            'flex-wrap': 'Container.Layout.FlexWrap',
            'max-width': 'Container.Layout.MaxWidth',
            'bottom': 'Container.Layout.Bottom',
            'counter-reset': 'Container.Layout.CounterReset',
            'right': 'Container.Layout.Right',
            'box-sizing': 'Container.Layout.BoxSizing',
            'position': 'Container.Layout.Position',
            'table-layout': 'Container.Layout.TableLayout',
            'width': 'Container.Layout.Width',
            'max-height': 'Container.Layout.MaxHeight',
            'column-width': 'Container.Layout.ColumnWidth',
            'min-width': 'Container.Layout.MinWidth',
            'vertical-align': 'Container.Layout.VerticalAlign',
            'perspective-origin': 'Container.Layout.PerspectiveOrigin',
            'align-content': 'Container.Layout.AlignContent',
            'flex-flow': 'Container.Layout.FlexFlow',
            'display': 'Container.Layout.Display',
            'left': 'Container.Layout.Left',
            'background-image': 'Container.Style.BackgroundImage',
            'border-left-style': 'Container.Style.BorderLeftStyle',
            'transition-delay': 'Container.Style.TransitionDelay',
            'animation-duration': 'Container.Style.AnimationDuration',
            'list-style': 'Container.Style.ListStyle',
            'outline-width': 'Container.Style.OutlineWidth',
            'border-top-left-radius': 'Container.Style.BorderTopLeftRadius',
            'white-space': 'Container.Style.WhiteSpace',
            'border-right': 'Container.Style.BorderRight',
            'text-decoration-line': 'Container.Style.TextDecorationLine',
            'animation-delay': 'Container.Style.AnimationDelay',
            'background-position': 'Container.Style.BackgroundPosition',
            'border-image': 'Container.Style.BorderImage',
            'border-spacing': 'Container.Style.BorderSpacing',
            'border-image-outset': 'Container.Style.BorderImageOutset',
            'border-image-slice': 'Container.Style.BorderImageSlice',
            'border-left-color': 'Container.Style.BorderLeftColor',
            'font-size': 'Container.Style.FontSize',
            'line-height': 'Container.Style.LineHeight',
            'text-decoration-style': 'Container.Style.TextDecorationStyle',
            'backface-visibility': 'Container.Style.BackfaceVisibility',
            'border-right-style': 'Container.Style.BorderRightStyle',
            'text-decoration': 'Container.Style.TextDecoration',
            'transition': 'Container.Style.Transition',
            'animation-iteration-count': 'Container.Style.AnimationIterationCount',
            'border-bottom': 'Container.Style.BorderBottom',
            'animation-timing-function': 'Container.Style.AnimationTimingFunction',
            'border-radius': 'Container.Style.BorderRadius',
            'quotes': 'Container.Style.Quotes',
            'tab-size': 'Container.Style.TabSize',
            'animation-fill-mode': 'Container.Style.AnimationFillMode',
            'background-size': 'Container.Style.BackgroundSize',
            'font-size-adjust': 'Container.Style.FontSizeAdjust',
            'list-style-position': 'Container.Style.ListStylePosition',
            'text-align': 'Container.Style.TextAlign',
            'text-justify': 'Container.Style.TextJustify',
            'background-attachment': 'Container.Style.BackgroundAttachment',
            'border-right-width': 'Container.Style.BorderRightWidth',
            'font': 'Container.Style.Font',
            'border-left': 'Container.Style.BorderLeft',
            'transition-duration': 'Container.Style.TransitionDuration',
            'word-spacing': 'Container.Style.WordSpacing',
            'animation-name': 'Container.Style.AnimationName',
            'animation-play-state': 'Container.Style.AnimationPlayState',
            'letter-spacing': 'Container.Style.LetterSpacing',
            'border-bottom-style': 'Container.Style.BorderBottomStyle',
            'word-break': 'Container.Style.WordBreak',
            'border-bottom-right-radius': 'Container.Style.BorderBottomRightRadius',
            'font-style': 'Container.Style.FontStyle',
            'order': 'Container.Style.Order',
            'outline-style': 'Container.Style.OutlineStyle',
            'border-bottom-left-radius': 'Container.Style.BorderBottomLeftRadius',
            'border-image-source': 'Container.Style.BorderImageSource',
            'text-align-last': 'Container.Style.TextAlignLast',
            'border-image-width': 'Container.Style.BorderImageWidth',
            'font-weight': 'Container.Style.FontWeight',
            'list-style-image': 'Container.Style.ListStyleImage',
            'opacity': 'Container.Style.Opacity',
            'clear': 'Container.Style.Clear',
            'border-top-color': 'Container.Style.BorderTopColor',
            'border': 'Container.Style.Border',
            'border-right-color': 'Container.Style.BorderRightColor',
            'transition-timing-function': 'Container.Style.TransitionTimingFunction',
            'border-bottom-width': 'Container.Style.BorderBottomWidth',
            'border-style': 'Container.Style.BorderStyle',
            'border-top-right-radius': 'Container.Style.BorderTopRightRadius',
            'caption-side': 'Container.Style.CaptionSide',
            'font-family': 'Container.Style.FontFamily',
            'text-decoration-color': 'Container.Style.TextDecorationColor',
            'transition-property': 'Container.Style.TransitionProperty',
            'background-origin': 'Container.Style.BackgroundOrigin',
            'text-indent': 'Container.Style.TextIndent',
            'visibility': 'Container.Style.Visibility',
            'border-color': 'Container.Style.BorderColor',
            'border-top': 'Container.Style.BorderTop',
            'font-variant': 'Container.Style.FontVariant',
            'outline': 'Container.Style.Outline',
            'border-bottom-color': 'Container.Style.BorderBottomColor',
            'border-top-style': 'Container.Style.BorderTopStyle',
            'border-width': 'Container.Style.BorderWidth',
            'list-style-type': 'Container.Style.ListStyleType',
            'outline-offset': 'Container.Style.OutlineOffset',
            'animation': 'Container.Style.Animation',
            'background': 'Container.Style.Background',
            'background-repeat': 'Container.Style.BackgroundRepeat',
            'border-top-width': 'Container.Style.BorderTopWidth',
            'word-wrap': 'Container.Style.WordWrap',
            'background-color': 'Container.Style.BackgroundColor',
            'text-overflow': 'Container.Style.TextOverflow',
            'text-shadow': 'Container.Style.TextShadow',
            'background-clip': 'Container.Style.BackgroundClip',
            'border-left-width': 'Container.Style.BorderLeftWidth',
            'resize': 'Container.Style.Resize',
            'animation-direction': 'Container.Style.AnimationDirection',
            'color': 'Container.Style.Color',
            'outline-color': 'Container.Style.OutlineColor',
            'border-image-repeat': 'Container.Style.BorderImageRepeat',
            'font-stretch': 'Container.Style.FontStretch',
            'text-transform': 'Container.Style.TextTransform',
            'flex-grow': 'Content.Layout.FlexGrow',
            'align-self': 'Content.Layout.AlignSelf',
            'content': 'Content.Layout.Content',
            'column-span': 'Content.Layout.ColumnSpan',
            'flex': 'Content.Layout.Flex',
            'flex-shrink': 'Content.Layout.FlexShrink',
            'flex-basis': 'Content.Layout.FlexBasis',
            'align-items': 'Content.Layout.AlignItems',
            'column-rule-width': 'Content.Style.ColumnRuleWidth',
            'column-rule': 'Content.Style.ColumnRule',
            'direction': 'Content.Style.Direction',
            'column-rule-style': 'Content.Style.ColumnRuleStyle',
            'column-rule-color': 'Content.Style.ColumnRuleColor',
            'column-fill': 'Content.Style.ColumnFill',
            'empty-cells': 'Content.Style.EmptyCells',
            'cursor': 'Content.Style.Cursor',
            'transform': 'Container.Style.Transform',
            'pointer-events': 'Container.Style.PointerEvents',
            'user-select': 'Container.Style.UserSelect',
            'backdrop-filter': 'Container.Style.BackdropFilter',
            'object-fit': 'Container.Style.ObjectFit',
            'object-position': 'Container.Style.ObjectPosition',
            'margin': 'Container.Layout.Margin',
            'margin-top': 'Container.Layout.MarginTop',
            'margin-right': 'Container.Layout.MarginRight',
            'margin-bottom': 'Container.Layout.MarginBottom',
            'margin-left': 'Container.Layout.MarginLeft',
            'padding-top': 'Container.Layout.PaddingTop',
            'padding-right': 'Container.Layout.PaddingRight',
            'padding-bottom': 'Container.Layout.PaddingBottom',
            'padding-left': 'Container.Layout.PaddingLeft',
            'grid-template': 'Container.Layout.GridTemplate',
            'grid-auto-columns': 'Container.Layout.GridAutoColumns', // Not in Go
            'grid-auto-rows': 'Container.Layout.GridAutoRows', // Not in Go
            'grid-auto-flow': 'Container.Layout.GridAutoFlow', // ?? in go?
            'grid': 'Container.Layout.Grid', // ?? in go?
            'grid-gap': 'Container.Layout.GridGap', // Not in Go
            'grid-row-gap': 'Container.Layout.GridRowGap',// Not in Go
            'grid-column-gap': 'Container.Layout.GridColumnGap', // Not in Go
            'grid-row-start': 'Container.Layout.GridRowStart', // Not in Go
            'grid-column-start': 'Container.Layout.GridColumnStart', // Not in Go
            'padding': 'Container.Layout.Padding',
            'grid-template-columns': 'Container.Layout.GridTemplateColumns',
            'grid-template-rows': 'Container.Layout.GridTemplateRows',
            'grid-column': 'Container.Layout.GridColumn',
            'grid-row': 'Container.Layout.GridRow',
            'gap': 'Container.Layout.Gap',
            'scroll-behavior': 'Container.Layout.ScrollBehavior'
        };
    </script>

    <script>
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function getMethodCall(property, value) {
            const capitalizedProperty = property.split('-').map(capitalizeFirstLetter).join('');
            if (value.match(/^[a-zA-Z-]+$/)) {
                return `${capitalizedProperty}(e)`;
            } else {
                return `${capitalizedProperty}.Value("${value}")(e)`;
            }
        }

        // Modify cssToGoCode function to generate a complete Go package
        function cssToGoCode(css) {
            const lines = css.split('\n');
            let goCode = '';
            let errors = [];
            let lineNumber = 1;
            let inRule = false;
            let currentSelector = '';

            for (let line of lines) {
                line = line.trim();

                if (line.includes('{')) {
                    inRule = true;
                    currentSelector = line.split('{')[0].trim();
                    let funcName = currentSelector.replace(/[^\w]/g, '').replace(/^[0-9]/, '_$&') + 'Style';
                    funcName = funcName.charAt(0).toUpperCase() + funcName.slice(1);
                    goCode += `func ${funcName}(e *ui.Element) *ui.Element {\n`;
                } else if (line.includes('}')) {
                    inRule = false;
                    goCode += `\treturn e\n}\n\n`;
                    currentSelector = '';
                } else if (inRule && line.includes(':')) {
                    const [property, value] = line.split(':').map(s => s.trim());
                    if (cssToGoMapping[property]) {
                        const [namespace, category] = cssToGoMapping[property].split('.');
                        goCode += `\te = doc.CSS.${namespace}.${category}.${getMethodCall(property, value.replace(';', ''))}\n`;
                    } else {
                        errors.push({ property, selector: currentSelector, lineNumber: lineNumber });
                        goCode += `\t// ERROR: Unknown property "${property}"\n`;
                    }
                }

                lineNumber++;
            }

            return { goCode: goCode.trim(), errors: errors };
        }


    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let elementCount = 0;
            let currentSheetName = sessionStorage.getItem('currentSheetName') || 'Untitled';
            let hasUnsavedChanges = false;

            // Global style controls
            const fontFamily = document.getElementById('font-family');
            const fontSize = document.getElementById('font-size');
            const fontSizeValue = document.getElementById('font-size-value');
            const textColor = document.getElementById('text-color');
            const lineHeight = document.getElementById('line-height');
            const lineHeightValue = document.getElementById('line-height-value');
            const pagePadding = document.getElementById('page-padding');
            const pagePaddingValue = document.getElementById('page-padding-value');
            const pageWidth = document.getElementById('page-width');
            const pageWidthValue = document.getElementById('page-width-value');
            const globalCSS = document.getElementById('user-global-css');
            const newStylesheetButton = document.getElementById('new-stylesheet');
            const backgroundColorPicker = document.getElementById('color-picker');

            let BackgroundColor = '#ffffff';
            let Margin = '0 auto';
            let TextColor = '#000000';
            
            function updateGlobalCSS() {
                const resetCSSToggle = document.getElementById('reset-css-toggle');
                const resetCSSDisplay = document.getElementById('reset-css-display');
                const generatedCSSDisplay = document.getElementById('generated-css-display');
                const userGlobalCSS = document.getElementById('user-global-css');
                
                // Update reset CSS display
                resetCSSDisplay.textContent = resetCSSToggle.checked ? resetCSS : '';

                // Generate global CSS from controls
                const generatedCSS = `
                    body {
                        font-family: ${fontFamily.value};
                        font-size: ${fontSize.value}px;
                        color: ${textColor.value};
                        line-height: ${lineHeight.value};
                        padding: ${pagePadding.value}px;
                        max-width: ${pageWidth.value}px;
                        margin: ${Margin};
                        background-color: ${backgroundColorPicker.value};
                    }
                `;
                generatedCSSDisplay.textContent = formatGlobalCSS(generatedCSS);

                // Combine all CSS
                const combinedCSS = [
                    resetCSSToggle.checked ? resetCSS : '',
                    generatedCSS,
                    userGlobalCSS.value
                ].filter(Boolean).join('\n\n');

                // Apply combined CSS
                applyGlobalCSS(combinedCSS);
                saveCurrentState();
            }


            function applyGlobalCSS(css) {
                let styleTag = document.getElementById('global-styles');
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.id = 'global-styles';
                    document.head.appendChild(styleTag);
                }
                styleTag.textContent = css;
                updateBackgroundColorPicker();
            }

            // Add event listeners to all controls and the user CSS textarea
            document.querySelectorAll('.global-styles input, .global-styles select')
                .forEach(el => el.addEventListener('input', updateGlobalCSS));


            // Update display values for range inputs
            ['font-size', 'line-height'].forEach(id => {
                const input = document.getElementById(id);
                const display = document.getElementById(`${id}-value`);
                input.addEventListener('input', () => {
                    display.textContent = id === 'font-size' ? `${input.value}px` : input.value;
                });
            });


            // Add UI elements for saving, loading, and downloading stylesheets
            const uiControls = document.createElement('div');
            uiControls.innerHTML = `
                <select id="load-sheet">
                    <option value="" disabled selected>Load Sheet</option>
                </select>
                <button id="save-sheet">Save Sheet</button>
                <button id="delete-sheet" onclick="handleSheetDeletion()">Delete Sheet</button>
                <button id="download-sheet">Download Stylesheet</button>
                <button id="download-go-code">Download Go Code</button>
            `;
            document.body.insertBefore(uiControls, document.getElementById('element-selector'));


            // Attach event listeners
            if (backgroundColorPicker) {
                backgroundColorPicker.addEventListener('input', (e) => {
                    BackgroundColor = e.target.value;
                    updateGlobalCSS();
                    saveCurrentState();
                });
            }

            textColor.addEventListener('input', (e) => {
                TextColor = e.target.value;
                updateGlobalCSS();
                saveCurrentState();
            });

            document.getElementById('reset-css-toggle').addEventListener('change', () => {
                updateGlobalCSS();
                saveCurrentState();
            });

            fontFamily.addEventListener('change', () => {
                updateGlobalCSS();
                saveCurrentState();
            });

            fontSize.addEventListener('input', () => {
                updateGlobalCSS();
                saveCurrentState();
                document.getElementById('font-size-value').textContent = `${document.getElementById('font-size').value}px`;
            });

            lineHeight.addEventListener('input', () => {
                updateGlobalCSS();
                saveCurrentState();
                document.getElementById('line-height-value').textContent = document.getElementById('line-height').value;
            });

            pagePadding.addEventListener('input', () => {
                updateGlobalCSS();
                saveCurrentState();
            });

            pageWidth.addEventListener('input', () => {
                updateGlobalCSS();
                saveCurrentState();
            });


            if (newStylesheetButton) {
                newStylesheetButton.addEventListener('click', function () {
                    // Ask whether to save changes made to ($(sheetName)) before creating a new stylesheet if there are unsaved changes
                    if (hasUnsavedChanges) {
                        if (confirm('You have unsaved changes. Would you like to save them before creating a new stylesheet?')) {
                            saveCurrentState(true);
                        }
                    }

                    currentSheetName = 'Untitled';
                    loadDefaultState(); 
                    sessionStorage.removeItem("pending_save")
                    updateLoadSheetDropdown();
                    updateSaveIndicator();
                });
            }

            document.getElementById('add-element').addEventListener('click', () => {
                const selector = document.getElementById('element-selector');
                const selectedElement = selector.value;
                if (selectedElement) {
                    createEditorContainer(selectedElement);
                }
            });


            window.addEventListener('beforeunload', (event) => {
                pending_save = sessionStorage.getItem('pending_save');
                if (hasUnsavedChanges) {
                    event.preventDefault();
                    event.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                } else { 
                    sessionStorage.removeItem('pending_save'); // Clear the pending save flag
                }
            });

            function updateSaveIndicator() {
                const indicator = document.getElementById('save-indicator');
                // if pending_save is not in sessionstorage, then there is nothing saved and nothing to save 
                // so the indicator shouldn't be visible
                // if there is pending_save in sessionstorage, then there are saved or unsaved changes depending on
                // the value that has been stored.

                const pendingSave = sessionStorage.getItem('pending_save');
                if (!pendingSave) {
                    indicator.style.display = 'none';
                    return;
                }

                indicator.style.display = 'block';


                if (hasUnsavedChanges) {
                    indicator.textContent = 'Unsaved';
                    indicator.style.color = 'red';
                } else {
                    indicator.textContent = 'Saved';
                    indicator.style.color = 'green';
                }
            }

            const resetCSS = `/* CSS Reset */
*, *::before, *::after {
    box-sizing: border-box;
}
* {
    margin: 0;
}
body {
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
}
img, picture, video, canvas, svg {
    display: block;
    max-width: 100%;
}
input, button, textarea, select {
    font: inherit;
}
p, h1, h2, h3, h4, h5, h6 {
    overflow-wrap: break-word;
}
#root, #__next {
    isolation: isolate;
}

`;

            


            function getStylesheetList() {
                const list = localStorage.getItem('stylesheet_list');
                return list ? JSON.parse(list) : [];
            }

            function addStylesheetToList(sheetName) {
                const list = JSON.parse(localStorage.getItem('stylesheet_list') || '[]');
                if (!list.includes(sheetName)) {
                    list.push(sheetName);
                    localStorage.setItem('stylesheet_list', JSON.stringify(list));
                }
                updateLoadSheetDropdown();
            }

            function removeStylesheetFromList(sheetName) {
                const list = getStylesheetList();
                const index = list.indexOf(sheetName);
                if (index > -1) {
                    list.splice(index, 1);
                    localStorage.setItem('stylesheet_list', JSON.stringify(list));
                }
                updateLoadSheetDropdown();
            }



            function saveCurrentState(persist = false) {
                currentSheetName = currentSheetName;
                const elementsContainer = document.getElementById('elements-container');
                let date = new Date().toLocaleString();
                
                // Create a map of element IDs
                const elementIds = {};
                if (elementsContainer) {
                    elementsContainer.querySelectorAll('.editor-container').forEach((container, index) => {
                        const editableElement = container.querySelector('.editable-element');
                        if (editableElement && editableElement.id) {
                            elementIds[`element-${index}`] = editableElement.id;
                        }
                    });
                }

                const newState = {
                    title: `${currentSheetName}`,
                    elements: elementsContainer ? elementsContainer.innerHTML : '',
                    resetCSSEnabled: document.getElementById('reset-css-toggle').checked,
                    fontFamily: fontFamily.value,
                    fontSize: fontSize.value,
                    textColor: textColor.value,
                    lineHeight: lineHeight.value,
                    pagePadding: pagePadding.value,
                    pageWidth: pageWidth.value,
                    backgroundColor: BackgroundColor,
                    userGlobalCSS: document.getElementById('user-global-css').value,
                    currentSheetName: currentSheetName,
                    lastModified: date,
                    elementIds: elementIds 
                };

                // Compare with the previous state
                const previousStateJSON = sessionStorage.getItem(currentSheetName);
                const previousState = previousStateJSON ? JSON.parse(previousStateJSON) : null;
                
                let hasChanges = false;

                if (!previousState || JSON.stringify(newState) !== JSON.stringify(previousState)) {
                    hasChanges = true;
                    // Update session storage
                    sessionStorage.setItem(currentSheetName, JSON.stringify(newState));
                    document.title = newState.title;
                }

                if (persist && currentSheetName !== 'Untitled') {
                    localStorage.setItem(currentSheetName, JSON.stringify(newState));
                    sessionStorage.setItem('pending_save', 'false');
                    hasUnsavedChanges = false;
                } else if (hasChanges) {
                    hasUnsavedChanges = true;
                    let pndchg = sessionStorage.getItem('pending_save');
                    if (pndchg) {
                        sessionStorage.setItem('pending_save', 'true');
                    }
                }

                if (hasChanges || persist) {
                    updateSaveIndicator();
                    updateLoadSheetDropdown();
                }
            }
            
            // Function to load a state
            function loadState(sheetname) {
                let state;
                // Try to load from sessionStorage first (for temporary states/save points)
                let stateJSON = sessionStorage.getItem(sheetname);

                // If not found in sessionStorage, try localStorage (for saved stylesheets)
                if (!stateJSON) {
                    if (sheetname === 'Untitled') {
                        loadDefaultState();
                        return true;
                    }
                    stateJSON = localStorage.getItem(sheetname);
                }

                if (stateJSON) {
                    try {
                        state = JSON.parse(stateJSON);
                    } catch (e) {
                        console.error('Error parsing state JSON:', e);
                        return false;
                    }
                } else {
                    return false;
                }

                const elementsContainer = document.getElementById('elements-container');

                if (elementsContainer && state.elements) {
                    elementsContainer.innerHTML = state.elements;
                    
                    // Restore saved IDs
                    if (state.elementIds) {
                        Object.entries(state.elementIds).forEach(([index, oldId]) => {
                            const newId = `${sheetname}-element-${index}`;
                            const container = elementsContainer.querySelector(`[id="${oldId}"]`).closest('.editor-container');
                            if (container) {
                                const editableElement = container.querySelector('.editable-element');
                                if (editableElement) {
                                    editableElement.id = newId;
                                    
                                    // Update related element IDs and data attributes
                                    container.querySelectorAll(`[id^="${oldId}"], [data-for-element="${oldId}"]`).forEach(el => {
                                        if (el.id) el.id = el.id.replace(oldId, newId);
                                        if (el.dataset.forElement) el.dataset.forElement = newId;
                                    });
                                    
                                    // Update the style tag
                                    const styleTag = document.querySelector(`style[data-for="${oldId}"]`);
                                    if (styleTag) {
                                        styleTag.setAttribute('data-for', newId);
                                    }
                                }
                            }
                        });
                    }
                    
                    rebuildElements(elementsContainer);
                }

                TextColor = state.textColor || '#000000';
                textColor.value = TextColor

                BackgroundColor= state.backgroundColor;
                backgroundColorPicker.value = state.backgroundColor;

                // Restore global CSS settings
                document.getElementById('reset-css-toggle').checked = state.resetCSSEnabled;
                fontFamily.value = state.fontFamily;
                fontSize.value = state.fontSize;
                lineHeight.value = state.lineHeight;
                pagePadding.value = state.pagePadding;
                pageWidth.value = state.pageWidth;
                document.getElementById('user-global-css').value = state.userGlobalCSS;

                document.title = state.title || "Untitled - UI Kit Editor";
                currentSheetName = state.currentSheetName || sheetname;
                sessionStorage.setItem('currentSheetName', currentSheetName);

                updateGlobalCSS();
                reattachEventListeners();
                hasUnsavedChanges = false;
                sessionStorage.removeItem('pending_save');
                updateSaveIndicator();
                updateLoadSheetDropdown();
                return true;
            }
            
            function rebuildElements(elementsContainer) {
                elementsContainer.querySelectorAll('.editor-container').forEach((container) => {
                    const editableElement = container.querySelector('.editable-element');
                    if (editableElement) {
                        applyCSS(editableElement.id);
                    }
                });
                reattachEventListeners();
            }
            
            // function to delete current session state
            // it basically get the name of the currentstylesheet from sessionstorage
            // and then delete the item stored at this key
            function deleteCurrentState() {
                const sheetName = sessionStorage.getItem('currentSheetName');
                if (sheetName) {
                    sessionStorage.removeItem(sheetName);
                }
                // delete unsaved changes from buffer
                sessionStorage.removeItem('pending_save');
            }

            function loadDefaultState() {
                const elementsContainer = document.getElementById('elements-container');
                if (elementsContainer) {
                    elementsContainer.innerHTML = '';
                }

                // Set default values for global CSS controls
                BackgroundColor = '#ffffff';
                backgroundColorPicker.value = '#ffffff';  

                TextColor = '#000000';
                textColor.value = '#000000';
                
                document.getElementById('reset-css-toggle').checked = true;
                fontFamily.value = 'Arial, sans-serif';
                fontSize.value = '16';
                lineHeight.value = '1.5';
                pagePadding.value = '20';
                pageWidth.value = '800';
                document.getElementById('user-global-css').value = '';
                

                ['h1', 'h2', 'h3', 'p', 'ul', 'ol', 'a', 'button', 'form', 'blockquote', 'code', 'pre'].forEach(element => createEditorContainer(element));

                updateGlobalCSS();
                deleteCurrentState();
                updateSaveIndicator();
                sessionStorage.setItem('currentSheetName', currentSheetName);
                hasUnsavedChanges = false;
                updateLoadSheetDropdown();
                document.title = currentSheetName + " - UI Kit Editor";
            }

            function updateElementIds() {
                const elementsContainer = document.getElementById('elements-container');
                elementsContainer.querySelectorAll('.editor-container').forEach((container, index) => {
                    const editableElement = container.querySelector('.editable-element');
                    if (editableElement) {
                        const oldId = editableElement.id;
                        const newId = `${currentSheetName}-element-${index}`;
                        editableElement.id = newId;
                        
                        // Update related element IDs and data attributes
                        container.querySelectorAll(`[id^="${oldId}"], [data-for-element="${oldId}"]`).forEach(el => {
                            if (el.id) el.id = el.id.replace(oldId, newId);
                            if (el.dataset.forElement) el.dataset.forElement = newId;
                        });
                        
                        // Update the style tag
                        const styleTag = document.querySelector(`style[data-for="${oldId}"]`);
                        if (styleTag) {
                            styleTag.setAttribute('data-for', newId);
                        }
                    }
                });
            }

            // Function to reattach event listeners after loading state
            function reattachEventListeners() {
                document.querySelectorAll('.editor-container').forEach((editorContainer) => {
                    const editableElementContainer = editorContainer.querySelector('.editable-element-container');
                    const editableElement = editableElementContainer.querySelector('.editable-element');
                    const htmlEditor = editorContainer.querySelector('.html-editor');                
                    const cssDisplay = editorContainer.querySelector('.css-display');
                    const cssTextareas = editorContainer.querySelectorAll('.css-textarea');
                    const pseudoSelector = editorContainer.querySelector('.pseudo-selector-select');
                    const goCodeDetails = editorContainer.querySelector('.go-code-details');
                    const goCodeDisplay = editorContainer.querySelector('.go-code-display');
                

                    function toggleCSSEdit() {
                        const currentTextarea = editorContainer.querySelector(`.css-textarea[data-pseudo="${pseudoSelector.value}"]`);
                        if (cssDisplay.style.display !== 'none') {
                            cssDisplay.style.display = 'none';
                            currentTextarea.style.display = 'block';
                            currentTextarea.focus();
                        } else {
                            cssDisplay.style.display = 'block';
                            currentTextarea.style.display = 'none';
                            updateCSSDisplay(editorContainer, elementType, pseudoSelector.value);
                        }
                    }

                    function updateGoCode() {
                        const cssTextarea = editorContainer.querySelector('.css-textarea[data-pseudo=""]');
                        const { goCode } = cssToGoCode(cssTextarea.value, elementType);
                        goCodeDisplay.textContent = goCode;
                    }

                    cssDisplay.addEventListener('dblclick', toggleCSSEdit);
                    cssDisplay.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            toggleCSSEdit();
                        }
                    });

                    cssTextareas.forEach(textarea => {
                        textarea.addEventListener('blur', () => {
                            textarea.value = formatCSSProperties(textarea.value);
                            toggleCSSEdit();
                            applyCSS(editorContainer.id);
                            updateGoCode();
                            saveCurrentState();
                        });
                        textarea.addEventListener('input', () => {
                            updateCSSDisplay(editorContainer, elementType, pseudoSelector.value);
                            if (goCodeDetails.open) {
                                updateGoCode();
                            }
                        });

                        textarea.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') {
                            this.blur();
                        } else if (e.key === 'Enter') {
                            if (e.shiftKey && e.ctrlKey) {
                                // Shift + Control + Enter: Insert new line with indentation
                                e.preventDefault();
                                const start = this.selectionStart;
                                const end = this.selectionEnd;
                                const value = this.value;
                                
                                // Find the start of the current line
                                let lineStart = value.lastIndexOf('\n', start - 1) + 1;
                                let indent = '';
                                
                                // Calculate the current line's indentation
                                for (let i = lineStart; i < value.length; i++) {
                                    if (value[i] === ' ' || value[i] === '\t') {
                                        indent += value[i];
                                    } else {
                                        break;
                                    }
                                }
                                
                                // Insert new line with indentation
                                const insertion = '\n' + indent;
                                this.value = value.substring(0, start) + insertion + value.substring(end);
                                
                                // Move the cursor to the end of the inserted indentation
                                this.selectionStart = this.selectionEnd = start + insertion.length;
                            } else if (!e.shiftKey && !e.ctrlKey) {
                                // Plain Enter: Save and blur
                                e.preventDefault();
                                this.blur();
                            }
                        } else if (e.key === 'Tab') {
                            e.preventDefault(); // Prevent default tab behavior
                            const start = this.selectionStart;
                            const end = this.selectionEnd;
                            const value = this.value;
                            if (start === end) {
                                // No selection, just insert or remove tab
                                if (!e.shiftKey) {
                                    // Insert tab
                                    this.value = value.substring(0, start) + "\t" + value.substring(end);
                                    this.selectionStart = this.selectionEnd = start + 1;
                                } else if (start > 0) {
                                    // Remove tab (if exists) at the start of the line
                                    const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                                    if (value[lineStart] === '\t') {
                                        this.value = value.substring(0, lineStart) + value.substring(lineStart + 1);
                                        this.selectionStart = this.selectionEnd = start - 1;
                                    }
                                }
                            } else {
                                // Text is selected, indent or unindent block
                                const lines = value.substring(start, end).split('\n');
                                const indentedLines = lines.map(line => 
                                    !e.shiftKey ? '\t' + line : line.startsWith('\t') ? line.substring(1) : line
                                );
                                const replacement = indentedLines.join('\n');
                                this.value = value.substring(0, start) + replacement + value.substring(end);
                                this.selectionStart = start;
                                this.selectionEnd = start + replacement.length;
                            }
                        }
                    }); 
                
                });

                pseudoSelector.addEventListener('change', () => {
                    // toggleCSSEdit();
                    applyCSS(editorContainer.id);
                });


                editableElement.addEventListener('dblclick', function () {
                    if (goCodeDetails.open) {
                        goCodeDetails.open = false;
                    }
                    htmlEditor.value = this.innerHTML;
                    this.style.display = 'none';
                    htmlEditor.style.display = 'block';
                    htmlEditor.focus();
                });

                htmlEditor.addEventListener('blur', function () {
                    const originalContent = editableElement.innerHTML;
                    try {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(this.value, 'text/html');
                        if (doc.body.firstChild) {
                            editableElement.innerHTML = this.value;
                        } else {
                            throw new Error('Invalid HTML');
                        }
                    } catch (e) {
                        console.error('Invalid HTML:', e);
                        editableElement.innerHTML = editableElement.getAttribute('data-original-html');
                    }

                    this.style.display = 'none';
                    editableElement.style.display = 'block';

                    // Only save if the content has changed
                    if (originalContent !== editableElement.innerHTML) {
                        const elementName = editorContainer.querySelector('h2').textContent;
                        saveCurrentState();
                    }

                    //applyCSS(id);
                });

                htmlEditor.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        this.blur();
                    } else if (e.key === 'Tab') {
                        e.preventDefault(); // Prevent default tab behavior

                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        const value = this.value;

                        if (start === end) {
                            // No selection, just insert tab
                            if (!e.shiftKey) {
                                // Insert tab
                                this.value = value.substring(0, start) + "\t" + value.substring(end);
                                this.selectionStart = this.selectionEnd = start + 1;
                            } else if (start > 0) {
                                // Remove tab (if exists) at the start of the line
                                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                                if (value[lineStart] === '\t') {
                                    this.value = value.substring(0, lineStart) + value.substring(lineStart + 1);
                                    this.selectionStart = this.selectionEnd = start - 1;
                                }
                            }
                        } else {
                            // Text is selected, indent or unindent block
                            const lines = value.substring(start, end).split('\n');
                            const indentedLines = lines.map(line => 
                                !e.shiftKey ? '\t' + line : line.startsWith('\t') ? line.substring(1) : line
                            );
                            const replacement = indentedLines.join('\n');
                            this.value = value.substring(0, start) + replacement + value.substring(end);
                            this.selectionStart = start;
                            this.selectionEnd = start + replacement.length;
                        }
                    }
                });

                editorContainer.querySelector('.remove-element').addEventListener('click', () => {
                    editorContainer.remove();
                    clearElementStyles(id);
                    updateElementIds();
                    saveCurrentState();
                    updateElementSelector();
                });

                goCodeDetails.addEventListener('toggle', (event) => {
                    if (event.target.open) {
                        updateGoCode();
                    }
                });

                    applyCSS(id);
                });
            }

            // Function to create stylesheet
            function createStylesheet() {
                let stylesheet = '';

                // Add Reset CSS if enabled
                const resetCSSToggle = document.getElementById('reset-css-toggle');
                if (resetCSSToggle && resetCSSToggle.checked) {
                    stylesheet += resetCSS + '\n\n';
                }

                // Add generated global styles
                stylesheet += `body {
                    font-family: ${fontFamily.value};
                    font-size: ${fontSize.value}px;
                    color: ${textColor.value};
                    line-height: ${lineHeight.value};
                    padding: ${pagePadding.value}px;
                    max-width: ${pageWidth.value}px;
                    margin: ${Margin};
                    background-color: ${BackgroundColor};
                }\n\n`;

                // Add user-defined global CSS
                const userGlobalCSS = document.getElementById('user-global-css');
                if (userGlobalCSS && userGlobalCSS.value.trim()) {
                    stylesheet += userGlobalCSS.value + '\n\n';
                }

                // Add styles for each editor container
                // Add styles for each editor container
                document.querySelectorAll('.editor-container').forEach((editorContainer) => {
                    const styleTag = document.querySelector(`style[data-for="${editorContainer.id}"]`);
                    if (styleTag) {
                        stylesheet += styleTag.textContent + '\n\n';
                    }
                });

                return formatGlobalCSS(stylesheet);
            }


            function deleteStylesheet(sheetName) {
                if (confirm(`Are you sure you want to delete the stylesheet "${sheetName}"? This action cannot be undone.`)) {
                    localStorage.removeItem(sheetName);
                    removeStylesheetFromList(sheetName);
                    updateLoadSheetDropdown();
                }
            }


            // Populate the load sheet dropdown
            function updateLoadSheetDropdown() {
                const loadSheet = document.getElementById('load-sheet');
                if (!loadSheet) {
                    console.error("Load sheet dropdown not found");
                    return;
                }

                // Clear existing options
                loadSheet.innerHTML = '<option value="" disabled selected>Load Sheet</option>';

                // deactivate that option value


                // Get all saved stylesheets from localStorage
                const stylesheetList = getStylesheetList();

                stylesheetList.forEach(sheetName => {
                    const option = document.createElement('option');
                    option.value = sheetName;
                    option.textContent = sheetName;
                    if (sheetName === currentSheetName) {
                        option.selected = true;
                    }
                    loadSheet.appendChild(option);
                });

                // Update delete button state
                updateDeleteButtonState();
            }

            function updateDeleteButtonState() {
                const deleteButton = document.getElementById('delete-sheet');
                const loadSheet = document.getElementById('load-sheet');
                
                if (deleteButton && loadSheet) {
                    const selectedSheetName = loadSheet.value;
                    deleteButton.disabled = !selectedSheetName || selectedSheetName === currentSheetName;
                }
            }

            function handleSheetDeletion() {
                const loadSheet = document.getElementById('load-sheet');
                const selectedSheetName = loadSheet.value;
                
                if (selectedSheetName && selectedSheetName !== currentSheetName) {
                    if (confirm(`Are you sure you want to delete the sheet "${selectedSheetName}"?`)) {
                        deleteStylesheet(selectedSheetName);
                        updateLoadSheetDropdown();
                    }
                }
            }

            // Event listeners for new UI controls
            document.getElementById('save-sheet').addEventListener('click', () => {
                let sheetname = currentSheetName;
                // prompt for non empty string sheet name
                if (sheetname === 'Untitled') {
                    sheetname = prompt('Enter a name for the stylesheet');
                    if (sheetname === null) {
                        return;
                    }
                    while (sheetname === 'Untitled') {
                        sheetname = prompt('Please enter a non-empty name for the stylesheet');
                        if (sheetname === null) {
                            return;
                        }
                    }
                }
                currentSheetName = sheetname;
                addStylesheetToList(currentSheetName);
                saveCurrentState(true);  // Pass true to indicate an explicitly persisted save
                updateLoadSheetDropdown();
                updateSaveIndicator();  // Update the save indicatorTODO review necessity for these calls
            });

            document.getElementById('load-sheet').addEventListener('change', (e) => {
                const selectedSheetName = e.target.value;
                
                currentSheetName = selectedSheetName;
                if (selectedSheetName) {
                    loaded = loadState(selectedSheetName);
                    if (!loaded){
                        document.body.innerHTML = 'SYSERR: failure loading stylesheet ${selectedSheetName}';
                        document.title = 'SYSERR';
                        return; 
                    }
                    document.title = selectedSheetName + ' - UI Kit Editor';
                    
                }
                updateLoadSheetDropdown();
                updateDeleteButtonState();
            });

            document.getElementById('download-sheet').addEventListener('click', () => {
                const stylesheet = createStylesheet();
                const currentDate = new Date().toLocaleString();
                const htmlContent = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${currentSheetName} - CSS Stylesheet</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                line-height: 1.6;
                                padding: 20px;
                                max-width: 800px;
                                margin: 0 auto;
                            }
                            h1 {
                                border-bottom: 1px solid #ccc;
                                padding-bottom: 10px;
                            }
                            pre {
                                background-color: #f4f4f4;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                padding: 15px;
                                white-space: pre-wrap;
                                word-wrap: break-word;
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${currentSheetName} - CSS Stylesheet</h1>
                        <p>Generated on: ${currentDate}</p>
                        <pre>${stylesheet}</pre>
                    </body>
                    </html>
                `;
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                window.open(url, '_blank');

                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 100);
            });

            function generateFullGoPackage(styleFunctions, packageName) {
                return `package ${packageName}

import (
    ui "github.com/atdiar/particleui"
    doc "github.com/atdiar/particleui/drivers/js"
    . "github.com/atdiar/particleui/drivers/js/declarative"
)

${styleFunctions}`;
            }




            function createEditorContainer(elementType) {
                const elementsContainer = document.getElementById('elements-container');
                const index = elementsContainer.children.length;
                const id = `${currentSheetName}-element-${index}`;
                const editorContainer = document.createElement('div');
                editorContainer.className = 'editor-container';
                editorContainer.id = id;                

                let elementName;
                switch (elementType) {
                    case 'a': elementName = 'Anchor'; break;
                    case 'blockquote': elementName = 'Block Quote'; break;
                    case 'button': elementName = 'Button'; break;
                    case 'code': elementName = 'Code'; break;
                    case 'div': elementName = 'Division'; break;
                    case 'form': elementName = 'Form'; break;
                    case 'h1': elementName = 'Heading 1'; break;
                    case 'h2': elementName = 'Heading 2'; break;
                    case 'h3': elementName = 'Heading 3'; break;
                    case 'h4': elementName = 'Heading 4'; break;
                    case 'h5': elementName = 'Heading 5'; break;
                    case 'h6': elementName = 'Heading 6'; break;
                    case 'img': elementName = 'Image'; break;
                    case 'ol': elementName = 'Ordered List'; break;
                    case 'p': elementName = 'Paragraph'; break;
                    case 'pre': elementName = 'Preformatted Text'; break;
                    case 'table': elementName = 'Table'; break;
                    case 'ul': elementName = 'Unordered List'; break;
                    default: elementName = elementType.charAt(0).toUpperCase() + elementType.slice(1);
                }

                let elementHtml;
                if (elementType === 'form') {
                    elementHtml = `
                        <form id="${id}">
                            <div>
                                <label for="${id}-text">Text Input:</label>
                                <input type="text" id="${id}-text" name="text" placeholder="Enter text">
                            </div>
                            <div>
                                <label for="${id}-password">Password:</label>
                                <input type="password" id="${id}-password" name="password" placeholder="Enter password">
                            </div>
                            <div>
                                <label for="${id}-email">Email:</label>
                                <input type="email" id="${id}-email" name="email" placeholder="Enter email">
                            </div>
                            <div>
                                <label for="${id}-number">Number:</label>
                                <input type="number" id="${id}-number" name="number" placeholder="Enter number">
                            </div>
                            <div>
                                <label for="${id}-date">Date:</label>
                                <input type="date" id="${id}-date" name="date">
                            </div>
                            <div>
                                <label for="${id}-checkbox">Checkbox:</label>
                                <input type="checkbox" id="${id}-checkbox" name="checkbox">
                            </div>
                            <div>
                                <label>Radio Buttons:</label>
                                <input type="radio" id="${id}-radio1" name="radio" value="1">
                                <label for="${id}-radio1">Option 1</label>
                                <input type="radio" id="${id}-radio2" name="radio" value="2">
                                <label for="${id}-radio2">Option 2</label>
                            </div>
                            <div>
                                <label for="${id}-select">Select:</label>
                                <select id="${id}-select" name="select">
                                    <option value="">Choose an option</option>
                                    <option value="1">Option 1</option>
                                    <option value="2">Option 2</option>
                                    <option value="3">Option 3</option>
                                </select>
                            </div>
                            <div>
                                <label for="${id}-textarea">Textarea:</label>
                                <textarea id="${id}-textarea" name="textarea" placeholder="Enter long text"></textarea>
                            </div>
                            <div>
                                <input type="submit" value="Submit">
                                <input type="reset" value="Reset">
                            </div>
                        </form>
                    `;
                } else if (elementType === 'a') {
                    elementHtml = `<a href="https://zui.dev" id="${id}" onclick="event.preventDefault();">Link to zui.dev</a>`;
                } else if (elementType.startsWith('input[type=')) {
                    const inputType = elementType.match(/'([^']+)'/)[1];
                    elementHtml = `<input type="${inputType}" id="${id}" placeholder="Sample ${inputType} input">`;
                } else if (elementType === 'ul' || elementType === 'ol') {
                    elementHtml = `<${elementType} id="${id}"><li>Item 1</li><li>Item 2</li><li>Item 3</li></${elementType}>`;
                } else if (elementType === 'select') {
                    elementHtml = `<select id="${id}"><option>Option 1</option><option>Option 2</option><option>Option 3</option></select>`;
                } else if (elementType === 'img') {
                    elementHtml = `<img id="${id}" src="https://via.placeholder.com/150" alt="Sample image">`;
                } else if (elementType === 'table') {
                    elementHtml = `
                        <table id="${id}">
                            <tr><th>Header 1</th><th>Header 2</th></tr>
                            <tr><td>Row 1, Cell 1</td><td>Row 1, Cell 2</td></tr>
                            <tr><td>Row 2, Cell 1</td><td>Row 2, Cell 2</td></tr>
                        </table>
                    `;
                } else if (elementType === 'blockquote') {
                    elementHtml = `<blockquote id="${id}">This is a blockquote. It is often used for quotations.</blockquote>`;
                } else if (elementType === 'code') {
                    elementHtml = `<code id="${id}">console.log("This is a code sample");</code>`;
                } else if (elementType === 'pre') {
                    elementHtml = `
<pre id="${id}"><code>
function example() {
    console.log("This is a preformatted code block");
}
</code></pre>`;
                } else if (elementType === 'body') {
                    elementHtml = `<div id="${id}" data-element-type="body">Body styles will be applied to the page body</div>`;
                } else {
                    elementHtml = `<${elementType} id="${id}">Sample ${elementType}</${elementType}>`;
                }
                

                editorContainer.innerHTML = `
    <div class="element-container">
        <h2>${elementName}</h2>
        <div class="editable-element-container">
            <i>Double-click to edit</i>
            <div class="editable-element">${elementHtml}</div>
        </div>
        <textarea class="html-editor" style="display: none; width: 100%; height: 150px;"></textarea>
        <button class="remove-element">Remove Element</button>
    </div>`;

    const cssEditorHtml = `
    <div class="css-editor">
        <div class="pseudo-selector">
            <label>Pseudo-selector:</label>
            <select class="pseudo-selector-select">
                <option value="">None</option>
                <option value=":hover">:hover</option>
                <option value=":active">:active</option>
                <option value=":focus">:focus</option>
                <option value=":visited">:visited</option>
                <option value=":first-child">:first-child</option>
                <option value=":last-child">:last-child</option>
                <option value=":nth-child(odd)">:nth-child(odd)</option>
                <option value=":nth-child(even)">:nth-child(even)</option>
            </select>
        </div>
        <div class="css-display-area">
            <i>Double-click to edit</i>
            <pre class="css-display" tabindex="0"></pre>
        </div>
        <div class="css-textareas">
            <textarea class="css-textarea" data-pseudo="" style="display: none;" placeholder="Add your CSS properties here"></textarea>
            <textarea class="css-textarea" data-pseudo=":hover" style="display: none;" placeholder="Add your CSS properties here"></textarea>
            <textarea class="css-textarea" data-pseudo=":active" style="display: none;" placeholder="Add your CSS properties here"></textarea>
            <textarea class="css-textarea" data-pseudo=":focus" style="display: none;" placeholder="Add your CSS properties here"></textarea>
            <textarea class="css-textarea" data-pseudo=":visited" style="display: none;" placeholder="Add your CSS properties here"></textarea>
            <textarea class="css-textarea" data-pseudo=":first-child" style="display: none;" placeholder="Add your CSS properties here"></textarea>
            <textarea class="css-textarea" data-pseudo=":last-child" style="display: none;" placeholder="Add your CSS properties here"></textarea>
            <textarea class="css-textarea" data-pseudo=":nth-child(odd)" style="display: none;" placeholder="Add your CSS properties here"></textarea>
            <textarea class="css-textarea" data-pseudo=":nth-child(even)" style="display: none;" placeholder="Add your CSS properties here"></textarea>
        </div>
    </div>`;

                editorContainer.innerHTML += cssEditorHtml;

                const editableElementContainer = editorContainer.querySelector('.editable-element-container');
                const editableElement = editableElementContainer.querySelector('.editable-element');
                const htmlEditor = editorContainer.querySelector('.html-editor');
                const cssDisplay = editorContainer.querySelector('.css-display');
                const cssTextareas = editorContainer.querySelectorAll('.css-textarea');
                const pseudoSelector = editorContainer.querySelector('.pseudo-selector-select');
                

                function toggleCSSEdit() {
                    const currentTextarea = editorContainer.querySelector(`.css-textarea[data-pseudo="${pseudoSelector.value}"]`);
                    if (cssDisplay.style.display !== 'none') {
                        cssDisplay.style.display = 'none';
                        currentTextarea.style.display = 'block';
                        currentTextarea.focus();
                    } else {
                        cssDisplay.style.display = 'block';
                        currentTextarea.style.display = 'none';
                        updateCSSDisplay(editorContainer, elementType, pseudoSelector.value);
                    }
                }


                cssDisplay.addEventListener('dblclick', toggleCSSEdit);
                cssDisplay.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        toggleCSSEdit();
                    }
                });

                cssTextareas.forEach(textarea => {
                    textarea.addEventListener('blur', () => {
                        textarea.value = formatCSSProperties(textarea.value);
                        toggleCSSEdit();
                        applyCSS(editorContainer.id);
                        saveCurrentState();
                    });
                    textarea.addEventListener('input', () => {
                        updateCSSDisplay(editorContainer, elementType, pseudoSelector.value);
    
                    });

                    textarea.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') {
                            this.blur();
                        } else if (e.key === 'Enter') {
                            if (e.shiftKey && e.ctrlKey) {
                                // Shift + Control + Enter: Insert new line with indentation
                                e.preventDefault();
                                const start = this.selectionStart;
                                const end = this.selectionEnd;
                                const value = this.value;
                                
                                // Find the start of the current line
                                let lineStart = value.lastIndexOf('\n', start - 1) + 1;
                                let indent = '';
                                
                                // Calculate the current line's indentation
                                for (let i = lineStart; i < value.length; i++) {
                                    if (value[i] === ' ' || value[i] === '\t') {
                                        indent += value[i];
                                    } else {
                                        break;
                                    }
                                }
                                
                                // Insert new line with indentation
                                const insertion = '\n' + indent;
                                this.value = value.substring(0, start) + insertion + value.substring(end);
                                
                                // Move the cursor to the end of the inserted indentation
                                this.selectionStart = this.selectionEnd = start + insertion.length;
                            } else if (!e.shiftKey && !e.ctrlKey) {
                                // Plain Enter: Save and blur
                                e.preventDefault();
                                this.blur();
                            }
                        } else if (e.key === 'Tab') {
                            e.preventDefault(); // Prevent default tab behavior
                            const start = this.selectionStart;
                            const end = this.selectionEnd;
                            const value = this.value;
                            if (start === end) {
                                // No selection, just insert or remove tab
                                if (!e.shiftKey) {
                                    // Insert tab
                                    this.value = value.substring(0, start) + "\t" + value.substring(end);
                                    this.selectionStart = this.selectionEnd = start + 1;
                                } else if (start > 0) {
                                    // Remove tab (if exists) at the start of the line
                                    const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                                    if (value[lineStart] === '\t') {
                                        this.value = value.substring(0, lineStart) + value.substring(lineStart + 1);
                                        this.selectionStart = this.selectionEnd = start - 1;
                                    }
                                }
                            } else {
                                // Text is selected, indent or unindent block
                                const lines = value.substring(start, end).split('\n');
                                const indentedLines = lines.map(line => 
                                    !e.shiftKey ? '\t' + line : line.startsWith('\t') ? line.substring(1) : line
                                );
                                const replacement = indentedLines.join('\n');
                                this.value = value.substring(0, start) + replacement + value.substring(end);
                                this.selectionStart = start;
                                this.selectionEnd = start + replacement.length;
                            }
                        }
                    }); 
                });

                pseudoSelector.addEventListener('change', () => {
                    toggleCSSEdit();
                    applyCSS(editorContainer.id);
                });


                editableElement.addEventListener('dblclick', function () {
                    htmlEditor.value = this.innerHTML;
                    this.style.display = 'none';
                    htmlEditor.style.display = 'block';
                    htmlEditor.focus();
                });

                htmlEditor.addEventListener('blur', function () {
                    const originalContent = editableElement.innerHTML;
                    try {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(this.value, 'text/html');
                        if (doc.body.firstChild) {
                            editableElement.innerHTML = this.value;
                        } else {
                            throw new Error('Invalid HTML');
                        }
                    } catch (e) {
                        console.error('Invalid HTML:', e);
                        editableElement.innerHTML = editableElement.getAttribute('data-original-html');
                    }

                    this.style.display = 'none';
                    editableElement.style.display = 'block';

                    // Only save if the content has changed
                    if (originalContent !== editableElement.innerHTML) {
                        const elementName = editorContainer.querySelector('h2').textContent;
                        saveCurrentState();
                    }
                });

                htmlEditor.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        this.blur();
                    } else if (e.key === 'Tab') {
                        e.preventDefault(); // Prevent default tab behavior

                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        const value = this.value;

                        if (start === end) {
                            // No selection, just insert tab
                            if (!e.shiftKey) {
                                // Insert tab
                                this.value = value.substring(0, start) + "\t" + value.substring(end);
                                this.selectionStart = this.selectionEnd = start + 1;
                            } else if (start > 0) {
                                // Remove tab (if exists) at the start of the line
                                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                                if (value[lineStart] === '\t') {
                                    this.value = value.substring(0, lineStart) + value.substring(lineStart + 1);
                                    this.selectionStart = this.selectionEnd = start - 1;
                                }
                            }
                        } else {
                            // Text is selected, indent or unindent block
                            const lines = value.substring(start, end).split('\n');
                            const indentedLines = lines.map(line => 
                                !e.shiftKey ? '\t' + line : line.startsWith('\t') ? line.substring(1) : line
                            );
                            const replacement = indentedLines.join('\n');
                            this.value = value.substring(0, start) + replacement + value.substring(end);
                            this.selectionStart = start;
                            this.selectionEnd = start + replacement.length;
                        }
                    }
                });

                editorContainer.querySelector('.remove-element').addEventListener('click', () => {
                    editorContainer.remove();
                    clearElementStyles(id);
                    updateElementIds();
                    saveCurrentState();
                    updateElementSelector();
                });

                const goCodeButton = document.createElement('button');
                goCodeButton.textContent = 'View Go Code';
                goCodeButton.classList.add('view-go-code-btn');
                editorContainer.appendChild(goCodeButton);

                goCodeButton.addEventListener('click', () => {
                    const cssDisplay = editorContainer.querySelector('.css-display');
                    const fullCSS = cssDisplay.textContent;
                    const { goCode, errors } = cssToGoCode(fullCSS);
                    const packageName = currentSheetName.replace(/[^\w]/g, '').toLowerCase();
                    const fullGoCode = generateFullGoPackage(goCode, packageName);
                    showModal(`${elementType} Go Code`, fullGoCode, errors);
                });

                elementsContainer.appendChild(editorContainer);

                updateCSSDisplay(editorContainer, elementType, '');
                applyCSS(id);

                saveCurrentState();
                updateElementSelector(); // Add this line
            }

            function updateElementSelector() {
                const elementSelector = document.getElementById('element-selector');
                const addedElements = new Set(Array.from(document.querySelectorAll('.editor-container')).map(container => 
                    container.querySelector('.editable-element').children[0].tagName.toLowerCase()
                ));

                Array.from(elementSelector.options).forEach(option => {
                    const elementType = option.value.split('[')[0]; // Handle cases like 'input[type='text']'
                    if (addedElements.has(elementType)) {
                        option.disabled = true;
                    } else {
                        option.disabled = false;
                    }
                });
            }

            document.getElementById('add-element').addEventListener('click', () => {
                const selector = document.getElementById('element-selector');
                const selectedElement = selector.value;
                if (selectedElement && !selector.options[selector.selectedIndex].disabled) {
                    createEditorContainer(selectedElement);
                    selector.value = ''; // Reset selection after adding
                } else if (selector.options[selector.selectedIndex].disabled) {
                    alert('This element has already been added.');
                }
            });

            function clearElementStyles(elementId) {
                const styleTag = document.querySelector(`style[data-for="${elementId}"]`);
                if (styleTag) {
                    styleTag.remove();
                }
            }

            function cssTextToObject(cssText) {
                const obj = {};
                const pairs = cssText.split(';');
                for (let i = 0; i < pairs.length; i++) {
                    const pair = pairs[i].split(':');
                    const property = pair[0].trim();
                    const value = pair[1] ? pair[1].trim() : '';
                    if (property && value) {
                        obj[property] = value;
                    }
                }
                return obj;
            }

            function objectToCSSText(obj) {
                return Object.entries(obj).map(([prop, value]) => `${prop}: ${value};`).join(' ');
            }

            function formatCSSProperties(css) {
                return css.split(';')
                    .map(prop => prop.trim())
                    .filter(prop => prop)
                    .map(prop => '  ' + prop + ';')
                    .join('\n');
            }


            function applyCSS(containerId) {
                const editorContainer = document.getElementById(containerId);
                if (!editorContainer) {
                    throw new Error(`Editor container with id ${containerId} not found.`);
                }

                const editableElement = editorContainer.querySelector('.editable-element');
                const cssEditor = editorContainer.querySelector('.css-editor');
                const cssTextareas = cssEditor.querySelectorAll('.css-textarea');
                const pseudoSelector = cssEditor.querySelector('.pseudo-selector-select');

                if (!editableElement || !cssEditor || cssTextareas.length === 0 || !pseudoSelector) {
                    throw new Error(`Required elements not found in container ${containerId}`);
                }

                const tagName = editableElement.children[0].tagName.toLowerCase();
                let cssContent = '';

                cssTextareas.forEach(textarea => {
                    const pseudo = textarea.dataset.pseudo;
                    const css = textarea.value.trim();
                    if (css) {
                        cssContent += `${tagName}${pseudo} {\n${css}\n}\n\n`;
                    }
                });

                updateCSS(containerId, formatGlobalCSS(cssContent));
                updateCSSDisplay(editorContainer, tagName, pseudoSelector.value);
            }

            function updateCSSDisplay(editorContainer, tagName, currentPseudo) {
                const cssDisplay = editorContainer.querySelector('.css-display');
                const cssTextarea = editorContainer.querySelector(`.css-textarea[data-pseudo="${currentPseudo}"]`);
                
                if (cssDisplay && cssTextarea) {
                    const css = cssTextarea.value.trim();
                    const formattedProperties = formatCSSProperties(css);
                    const formattedCSS = formatGlobalCSS(`${tagName}${currentPseudo} {\n${formattedProperties}\n}`);
                    cssDisplay.textContent = formattedCSS;
                }
            }

            function updateCSS(elementId, cssContent) {
                let styleTag = document.querySelector(`style[data-for="${elementId}"]`);
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.setAttribute('data-for', elementId);
                    document.head.appendChild(styleTag);
                }
                if (styleTag.textContent !== cssContent) {
                    styleTag.textContent = cssContent;
                }
            }

            function updateBackgroundColorPicker() {
                if (backgroundColorPicker) {
                    const computedStyle = getComputedStyle(document.body);
                    const currentBgColor = computedStyle.backgroundColor;
                    backgroundColorPicker.value = rgbToHex(currentBgColor);
                }
            }

            // Helper function to convert RGB to HEX
            function rgbToHex(rgb) {
                if (rgb.startsWith('#')) return rgb;
                const rgbValues = rgb.match(/\d+/g);
                if (!rgbValues) return '#ffffff';
                return "#" + rgbValues.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
            }

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
                        
/*
            // updateGlobalCSS is a function that applies the global CSS to the page
            // by setting the textContent of the style tag with the id 'global-styles'
            function updateGlobalCSS() {
                let styleTag = document.getElementById('global-styles');
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.id = 'global-styles';
                    document.head.appendChild(styleTag);
                }
                
                const resetCSSToggle = document.getElementById('reset-css-toggle');
                const userGlobalCSS = document.getElementById('user-global-css');
                
                // Combine reset CSS (if enabled), default styles, and user-defined styles
                let cssContent = '';
                
                if (resetCSSToggle.checked) {
                    cssContent += resetCSS + '\n\n';
                }
                
                const defaultStyles = `
                    body {
                        font-family: ${fontFamily.value};
                        font-size: ${fontSize.value}px;
                        color: ${textColor.value};
                        line-height: ${lineHeight.value};
                        padding: ${pagePadding.value}px;
                        max-width: ${pageWidth.value}px;
                        margin: ${Margin};
                        background-color: ${backgroundColorPicker.value};
                    }
                `;
                
                cssContent += formatGlobalCSS(defaultStyles) + '\n\n';
                
                if (userGlobalCSS.value.trim()) {
                    cssContent += formatGlobalCSS(userGlobalCSS.value);
                }
                
                styleTag.textContent = cssContent;
                
                // Update background color picker to reflect any changes
                updateBackgroundColorPicker();
                
                // Save the current state
                saveCurrentState();
            }

            // Event listeners for global style controls
            document.getElementById('reset-css-toggle').addEventListener('change', updateGlobalCSS);
            fontFamily.addEventListener('change', updateGlobalCSS);
            fontSize.addEventListener('input', updateGlobalCSS);
            textColor.addEventListener('input', updateGlobalCSS);
            lineHeight.addEventListener('input', updateGlobalCSS);
            pagePadding.addEventListener('input', updateGlobalCSS);
            pageWidth.addEventListener('input', updateGlobalCSS);
            backgroundColorPicker.addEventListener('input', updateGlobalCSS);
            document.getElementById('user-global-css').addEventListener('input', debounce(updateGlobalCSS, 300));

            // Update display values for range inputs
            ['font-size', 'line-height'].forEach(id => {
                const input = document.getElementById(id);
                const display = document.getElementById(`${id}-value`);
                input.addEventListener('input', () => {
                    display.textContent = id === 'font-size' ? `${input.value}px` : input.value;
                });
            });
*/
            function cssbeautify(style) {
                let formatted = '';
                let depth = 0;
                const indent = '\t'; // Use tab for indentation

                function newline(decreaseDepth = false) {
                    if (decreaseDepth) depth--;
                    return '\n' + indent.repeat(depth);
                }

                let rules = style.split('}');
                for (let i = 0; i < rules.length; i++) {
                    let rule = rules[i].trim();
                    if (rule.length === 0) continue;

                    let parts = rule.split('{');
                    if (parts.length === 1) {
                        // This is a single line rule (like @import)
                        formatted += rule + ';\n\n';
                    } else {
                        let selector = parts[0].trim();
                        let properties = parts[1].split(';').filter(prop => prop.trim().length > 0);

                        formatted += selector + ' {';
                        depth++;

                        for (let j = 0; j < properties.length; j++) {
                            let [key, value] = properties[j].split(':').map(part => part.trim());
                            formatted += newline() + key + ': ' + value + ';';
                        }

                        depth--;
                        formatted += newline() + '}';
                        
                        // Add an extra newline after each ruleset, except the last one
                        if (i < rules.length - 1) formatted += '\n\n';
                    }
                }

                // Remove any instances of three or more consecutive newlines
                formatted = formatted.replace(/\n{3,}/g, '\n\n');

                return formatted.trim();
            }


            function formatGlobalCSS(css) {
                if (!css || css.trim() === '') {
                    return '';
                }
                return cssbeautify(css);
            }

            if (globalCSS) {
                
                globalCSS.addEventListener('input', debounce(() => {
                    updateGlobalCSS();
                }, 75));

                globalCSS.addEventListener('blur', () => {
                    globalCSS.value = formatGlobalCSS(globalCSS.value);
                    updateGlobalCSS();
                    saveCurrentState();
                    updateSaveIndicator();
                });
                
                globalCSS.addEventListener('keydown', function(e){
                    if (e.key === 'Escape') {
                        this.blur();
                    } else if (e.key === 'Tab') {
                        e.preventDefault(); // Prevent default tab behavior

                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        const value = this.value;

                        if (start === end) {
                            // No selection, just insert tab
                            if (!e.shiftKey) {
                                // Insert tab
                                this.value = value.substring(0, start) + "\t" + value.substring(end);
                                this.selectionStart = this.selectionEnd = start + 1;
                            } else if (start > 0) {
                                // Remove tab (if exists) at the start of the line
                                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                                if (value[lineStart] === '\t') {
                                    this.value = value.substring(0, lineStart) + value.substring(lineStart + 1);
                                    this.selectionStart = this.selectionEnd = start - 1;
                                }
                            }
                        } else {
                            // Text is selected, indent or unindent block
                            const lines = value.substring(start, end).split('\n');
                            const indentedLines = lines.map(line => 
                                !e.shiftKey ? '\t' + line : line.startsWith('\t') ? line.substring(1) : line
                            );
                            const replacement = indentedLines.join('\n');
                            this.value = value.substring(0, start) + replacement + value.substring(end);
                            this.selectionStart = start;
                            this.selectionEnd = start + replacement.length;
                        }
                    }
                })

            }

            const modal = document.getElementById('goCodeModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalGoCode = document.getElementById('modalGoCode');
            const closeBtn = modal.querySelector('.close');
            const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusableElement = focusableElements[0];
            const lastFocusableElement = focusableElements[focusableElements.length - 1];

            function showModal(title, code, errors) {
                modalTitle.textContent = title;
                modalGoCode.textContent = code;
                
                // Display errors if any
                if (errors && errors.length > 0) {
                    const errorMessage = errors.map(error => 
                        `Error on line ${error.lineNumber}: Unknown property "${error.property}" in selector "${error.selector}"`
                    ).join('\n');
                    modalGoCode.textContent += '\n\n// Errors:\n' + errorMessage;
                }
                
                // Add or update copy button
                let copyButton = modal.querySelector('#copyGoCode');
                if (!copyButton) {
                    copyButton = document.createElement('button');
                    copyButton.id = 'copyGoCode';
                    copyButton.textContent = 'Copy Go Code';
                    copyButton.style.marginTop = '10px';
                    copyButton.style.padding = '10px 20px';
                    copyButton.style.border = 'none';
                    copyButton.style.borderRadius = '5px';
                    copyButton.style.backgroundColor = '#008CBA';
                    copyButton.style.color = 'white';
                    copyButton.style.cursor = 'pointer';
                    modalGoCode.parentNode.insertBefore(copyButton, modalGoCode.nextSibling);
                }

                copyButton.onclick = function() {
                    navigator.clipboard.writeText(modalGoCode.textContent).then(() => {
                        const originalText = this.textContent;
                        this.textContent = 'Copied!';
                        this.style.backgroundColor = '#28a745';
                        setTimeout(() => {
                            this.textContent = originalText;
                            this.style.backgroundColor = '#008CBA';
                        }, 2000);
                    }, (err) => {
                        console.error('Could not copy text: ', err);
                    });
                };
                
                modal.style.display = 'block';
                firstFocusableElement.focus();
                document.addEventListener('keydown', handleModalKeydown);
            }

            function closeModal() {
                modal.style.display = 'none';
                document.removeEventListener('keydown', handleModalKeydown);
            }

            function handleModalKeydown(e) {
                if (e.key === 'Escape') {
                    closeModal();
                } else if (e.key === 'Tab') {
                    // Trap focus within the modal
                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusableElement) {
                            e.preventDefault();
                            lastFocusableElement.focus();
                        }
                    } else {
                        if (document.activeElement === lastFocusableElement) {
                            e.preventDefault();
                            firstFocusableElement.focus();
                        }
                    }
                }
            }

            closeBtn.onclick = closeModal;

            window.onclick = (event) => {
                if (event.target === modal) {
                    closeModal();
                }
            };

            // Event listend for the download go code button
            document.getElementById('download-go-code').addEventListener('click', () => {
                let allStyleFunctions = '';
                let allErrors = [];
                const packageName = currentSheetName.replace(/[^\w]/g, '').toLowerCase();

                document.querySelectorAll('.editor-container').forEach(container => {
                    const cssDisplay = container.querySelector('.css-display');
                    const fullCSS = cssDisplay.textContent;
                    const { goCode, errors } = cssToGoCode(fullCSS);
                    allStyleFunctions += goCode + '\n\n';
                    if (errors.length > 0) {
                        allErrors.push({ elementType: container.querySelector('h2').textContent, errors });
                    }
                });

                const fullGoCode = generateFullGoPackage(allStyleFunctions, packageName);

                // Handle errors if any
                if (allErrors.length > 0) {
                    console.warn('Errors occurred during Go code generation:', allErrors);
                    // Optionally, display these errors to the user
                }

                // Display in new tab
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>${packageName} - UI Kit Editor</title>
                            <style>
                                body { font-family: monospace; white-space: pre-wrap; padding: 20px; }
                                pre { background-color: #f4f4f4; padding: 10px; border-radius: 5px; }
                                button { margin: 10px; padding: 5px 10px; }
                            </style>
                        </head>
                        <body>
                            <pre>${fullGoCode}</pre>
                            <button id="downloadBtn">Download Go File</button>
                            <button id="copyBtn">Copy Go Code</button>
                             <script>
                                document.getElementById('downloadBtn').addEventListener('click', function() {
                                    const blob = new Blob([document.querySelector('pre').textContent], { type: 'text/plain' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = '${packageName}.go';
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    URL.revokeObjectURL(url);
                                });

                                document.getElementById('copyBtn').addEventListener('click', function() {
                                    const codeText = document.querySelector('pre').textContent;
                                    navigator.clipboard.writeText(codeText).then(() => {
                                        const originalText = this.textContent;
                                        this.textContent = 'Copied!';
                                        this.style.backgroundColor = '#28a745';
                                        setTimeout(() => {
                                            this.textContent = originalText;
                                            this.style.backgroundColor = '';
                                        }, 2000);
                                    }, (err) => {
                                        console.error('Could not copy text: ', err);
                                    });
                                });
                            <\/script>
                        </body>
                    </html>
                `);
            });


            if (currentSheetName === 'Untitled') {
                loadDefaultState();
            } else {
                loadState(currentSheetName);
                updateGlobalCSS();
            }

            updateLoadSheetDropdown();
            updateSaveIndicator();

        });

    </script>
</body>

</html>